name: Run Stats

on:
  schedule:
    - cron: "0 0 * * *" # Executa 1 vez ao dia, √† meia-noite
  workflow_dispatch: # Permite execu√ß√£o manual
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  prepare_members:
    name: üì¶ Preparar dados de membros
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch organization members
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/orgs/mri-Qbox-Brasil/members > public/members.json

      - name: Merge kofi usernames into members.json
        run: |
          if [ -f public/kofi.json ] && [ -s public/kofi.json ]; then
            jq --slurpfile k public/kofi.json '
              map(
                . as $m |
                if ($m | type == "object") and ($m | has("login")) then
                  # Encontrar o kofi_username correspondente e adicion√°-lo ao objeto
                  ($k | map(select(.login == $m.login))[0] | {kofi_username}) as $ku |
                  ($m + ($ku // {}))  # Adiciona ou ignora o kofi_username
                else
                  $m  # Caso o item n√£o seja um objeto com login
                end
              )
            ' public/members.json > public/members.tmp.json && mv public/members.tmp.json public/members.json
            echo "Merged kofi usernames into public/members.json"
          else
            echo "public/kofi.json not found or empty; skipping merge"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff-index --quiet HEAD; then
            echo "Nenhuma altera√ß√£o encontrada. Finalizando o workflow com sucesso."
            exit 0
          fi
          git commit -m "Update organization members data"
          git push

#   create_release:
#     name: üöÄ Criar Release
#     runs-on: ubuntu-latest
#     needs: prepare_members
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Create GitHub Release
#         uses: comnoco/create-release-action@v2
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           tag_name: "${{ github.ref_name }}"
#           release_name: "Release ${GITHUB_REF_NAME}"
#           body: "Atualiza√ß√£o dos membros da organiza√ß√£o com novos dados de kofi_username."
#           draft: false
#           prerelease: false

#   post_to_discord:
#     name: üîî Notificar no Discord
#     runs-on: ubuntu-latest
#     needs: create_release
#     steps:
#       - name: Install jq
#         run: sudo apt-get update && sudo apt-get install -y jq

#       - name: Post to Discord
#         env:
#           DISCORD_WEBHOOK_URL: ${{ secrets.UPDATE_DISCORD_WEBHOOK }}
#           RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
#           RELEASE_TAG: ${{ github.ref_name }}
#           RELEASE_AUTHOR: ${{ github.actor }}
#         run: |
#           if [ -z "$DISCORD_WEBHOOK_URL" ]; then
#             echo "Webhook URL n√£o definido. Pulando o envio do webhook."
#             exit 0
#           fi
#           REPO_DESCRIPTION=$(curl -s https://api.github.com/repos/${{ github.repository }} | jq -r .description)
#           EMBED_DATA='{
#               "embeds": [{
#               "author": {
#                 "name": "Github - Updates",
#                 "icon_url": "'"${LOGO_URL:-}"'"
#               },
#               "title": "[${{ github.event.repository.name }}] Nova vers√£o dispon√≠vel: '"${RELEASE_TAG}"'",
#               "url": "'"${RELEASE_URL}"'",
#               "description": "'"${REPO_DESCRIPTION}"'",
#               "fields": [{
#                   "name": "O que h√° de novo?",
#                   "value": "Membros atualizados com novos dados."
#               }],
#               "color": 4243543,
#               "footer": {
#                 "text": "Realizado por: '"${RELEASE_AUTHOR}"'",
#                 "icon_url": "'"${LOGO_URL:-}"'"
#               },
#               "timestamp": "'"$(date --utc +%Y-%m-%dT%H:%M:%SZ)"'"
#               }]
#           }'
#           curl -H "Content-Type: application/json" \
#               -d "$EMBED_DATA" \
#               $DISCORD_WEBHOOK_URL
